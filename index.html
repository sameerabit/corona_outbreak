<html>

    <head>

        <title>Sri Lankan Covid-19 Outbreak</title>
        <script src='https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css' rel='stylesheet' />
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-62826290-2"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-62826290-2');
        </script>
        <script data-ad-client="ca-pub-5818064858161369" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <style>
            
            .marker {
                background-image: url('./images/hospital.png');
                background-size: cover;
                width: 25px;
                height: 25px;
                border-radius: 50%;
                cursor: pointer;
            }

            .mapboxgl-popup {
                max-width: 200px;
            }

            .mapboxgl-popup-content {
                text-align: center;
                font-family: 'Open Sans', sans-serif;
            }
        
        
        </style>
    
    
    </head>

    <body>
            <nav class="navbar navbar-light bg-light">
            <div class="row my-3 mx-auto">
                    <div class="col-12">
                        <h3 class="text-center">ශ්‍රී ලංකාවේ <span class="text-danger">කොවිඩ්-19</span> ව්‍යාප්තිය </h3>
                        <h4 class="text-center"><span class="text-danger">Covid-19</span> Outbreak of Sri Lanka </h4>
                        <h5 class="text-center">இலங்கையின் <span class="text-danger">கோவிட் -19</span> வெடிப்பு</h5>
                        <p class="text-center">Source: http://hpb.health.gov.lk/api-documentation</p>
                    </div>
                </div>
            </nav>
        <div class="container">
            <div class="row">
                <div class="col">
                        <div class="card-group">
                                <div class="card text-white bg-primary mb-3" style="max-width: 18rem;">
                                        
                                        <div class="card-body">
                                          <h5 class="card-title"> Total Cases</h5>
                                          <h1 id="local_total"></h1>
                                        </div>
                                      </div>
                                      <div class="card text-white bg-secondary mb-3" style="max-width: 18rem;">
                                        
                                        <div class="card-body">
                                          <h5 class="card-title"> New Cases</h5>
                                          <h1 id="local_new"></h1>

                                        </div>
                                      </div>
                                      <div class="card text-white bg-success mb-3" style="max-width: 18rem;">
                                        
                                        <div class="card-body">
                                          <h5 class="card-title"> Recovered</h5>
                                          <h1 id="local_recovered"></h1>

                                        </div>
                                      </div>
                                      <div class="card text-white bg-danger mb-3" style="max-width: 18rem;">
                                        
                                        <div class="card-body">
                                          <h5 class="card-title"> Deaths</h5>
                                          <h1  id="total_deaths"></h1>

                                        </div>
                                      </div>
                              </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <h4>Click on markers for hospital wise details <h4>
                    <div style="height:800px; width:700px" id='map'></div>
                    <div class="row">
                        <div class="col">
                            <a href="https://twitter.com/intent/tweet?button_hashtag=COVID19LK&ref_src=twsrc%5Etfw" class="twitter-hashtag-button" data-show-count="false">Tweet #COVID19LK</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                        </div>
                    </div>
                </div>
                <div class="col">
                        <div class="card bg-light mb-3 mt-4">
                                <div class="card-body">
                                  <h5 class="card-title">Islandwide Tested</h5>
                                  <h1 id="islandtt"></h1>
                                </div>
                        </div>
                        <div class="card bg-light mb-3">
                                <div class="card-body">
                                  <h5 class="card-title">Islandwide Newly Admitted</h5>
                                  <h1 id="islandna"></h1>
                                </div>
                        </div>
                        <div id="info_table">
                        <h4 id="hospital_name"></h4>
                        <table class="table">
                                <tbody>
                                  <tr>
                                    <th>Total locals being tested </th>
                                    <td id="cumulative_local"></td>
                                  </tr>
                                  <tr>
                                    <th>Total foreigners being tested</th>
                                    <td id="cumulative_foreign"></td>
                                  </tr>
                                  <tr>
                                    <th>Newly admitted Locals</th>
                                    <td id="treatment_local"></td>
                                  </tr>
                                  <tr>
                                    <th>Newly admitted Foreigners</th>
                                    <td id="treatment_foreign"></td>
                                   </tr>
                                   <tr>
                                    <th>Total being Tested</th>
                                    <td id="cumulative_total"></td>
                                    </tr>
                                    <tr>
                                    <th>Newly Admitted Total</th>
                                    <td id="treatment_total"></td>
                                    </tr>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
    </body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
    <script src="https://unpkg.com/es6-promise@4.2.4/dist/es6-promise.auto.min.js"></script>
    <script src="https://unpkg.com/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
  <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoidmlyYWphbWFyYSIsImEiOiJjazY5NHJ6ZHkwYzMzM29xam1uOXdjdGhoIn0.SfsSg0wg1gEnGAdx376BFQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [80.7718,7.8731],
            zoom: 7,
        });

        var hospitals = [
            {
                "id" : 1,
                "name" : "National Institute of Infectious Diseases",
                "latitude": 6.9228766,
                "longitude": 79.9171615
            },
            {
                "id": 2,
                "name": "National Hospital Sri Lanka", //6.918347,79.8657269
                "latitude": 6.918347,
                "longitude": 79.8657269
            },
            {
                "id": 3,
                "name": "TH - Ragama", //7.0290907,79.9218719
                "latitude": 7.0290907,
                "longitude": 79.9218719
            },
            {
                "id": 4,
                "name": "TH - Karapitiya", //6.0670781,80.2238849
                "latitude": 6.0670781,
                "longitude": 80.2238849
            },
            {
                "id": 5,
                "name": "TH - Anuradhapura", //8.3247705,80.4117795
                "latitude": 8.3247705,
                "longitude": 80.4117795
            },
            {
                "id": 6,
                "name": "TH - Kurunegala", //7.4791271,80.3569262
                "latitude": 7.4791271,
                "longitude": 80.3569262
            },
            {
                "id": 8,
                "name": "National Hospital Kandy", //7.2876208,80.6300749
                "latitude": 7.2876208,
                "longitude": 80.6300749
            },
            {
                "id": 9,
                "name": "TH \u2013 Batticaloa", //7.7080323,81.6884334
                "latitude": 7.7080323,
                "longitude": 81.6884334
            },
            {
                "id": 10,
                "name": "DGH- Gampaha", //7.0913598,79.9985205
                "latitude": 7.0913598,
                "longitude": 79.9985205
            },
            {
                "id": 11,
                "name": "DGH \u2013 Negombo", //7.2120397,79.8468064
                "latitude": 7.2120397,
                "longitude": 79.8468064
            },
            {
                "id": 12,
                "name": "TH \u2013 Rathnapura", //6.6868245,80.390899
                "latitude": 6.6868245,
                "longitude": 80.390899
            },
            {
                "id": 13,
                "name": "PGH \u2013 Badulla", //6.9918084,81.0501615
                "latitude": 6.9918084,
                "longitude": 81.0501615
            },
            {
                "id": 14,//6.9176987,79.8740737
                "name": "LRH", 
                "latitude": 6.9176987,
                "longitude": 79.8740737
            },
            {
                "id": 15,
                "name": "DMH",
                "latitude": 6.4828764,
                "longitude": 79.945673
            },
            {
                "id": 16,
                "name": "DGH \u2013 Polonnaruwa", //7.9432059,81.0073628
                "latitude": 7.9432059,
                "longitude": 81.0073628
            },
            {
                "id": 17,
                "name": "TH - Kalubowila", //6.8668909,79.8746724
                "latitude": 6.8668909,
                "longitude": 79.8746724
            }
        ];

        $(function(){

            $('#info_table').hide();

            var features = [];

            var coronaData = [];

            hospitals.forEach(hospital =>
                features.push({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [hospital.longitude, hospital.latitude]
                    },
                    properties: {
                        id: hospital.id,
                        title: hospital.name,
                        description: ''
                    }
                })
            );
            var geojson = {
                type: 'FeatureCollection',
                features: features
            };

            geojson.features.forEach(function(marker) {

                var el = document.createElement('div');
                var input = document.createElement("input");   // Create a <button> element
                input.type = 'hidden';
                input.value = marker.properties.id;   
                el.appendChild(input);
                el.className = 'marker';

                new mapboxgl.Marker(el)
                    .setLngLat(marker.geometry.coordinates)
                    .setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
                    .setHTML('<h6>' + marker.properties.title + '</h6><p>' + marker.properties.description + '</p>'))
                .addTo(map);

                el.addEventListener('click', (e) => 
                    { 
                        hospitalId = $(e.target.innerHTML).val();
                        hospitalInfo = coronaData.find(x => {return x.hospital_id==hospitalId});
                        
                        $('#hospital_name').html(hospitalInfo.hospital.name);
                        $('#cumulative_local').html(hospitalInfo.cumulative_local);
                        $('#cumulative_foreign').html(hospitalInfo.cumulative_foreign);
                        $('#treatment_local').html(hospitalInfo.treatment_local);
                        $('#treatment_foreign').html(hospitalInfo.treatment_foreign);
                        $('#cumulative_total').html(hospitalInfo.cumulative_total);
                        $('#treatment_total').html(hospitalInfo.treatment_total);

                        $('#info_table').show();

                    }
                ); 
            
            });

            

            axios.get('https://www.healthpromo.gov.lk/api/get-current-statistical')
                    .then(function (response) {
                        coronaData = response.data.data.hospital_data;
                        localTotalCases = response.data.data.local_total_cases;
                        local_recovered = response.data.data.local_recovered;
                        local_new_cases = response.data.data.local_new_cases;
                        local_deaths = response.data.data.local_deaths;

                        $('#local_total').html(localTotalCases);
                        $('#local_recovered').html(local_recovered);
                        $('#local_new').html(local_new_cases);
                        $('#total_deaths').html(local_deaths);

                        treatmentTotalIslandWide = coronaData.reduce((a, b) => a + +b.treatment_total, 0);
                        cumulativeTotalIslandWide = coronaData.reduce((a, b) => a + +b.cumulative_total, 0);
                        $('#islandtt').html(cumulativeTotalIslandWide);
                        $('#islandna').html(treatmentTotalIslandWide);


            })
            .catch(function (error) {
                    console.log(error);
            })
            .finally(function () {
            });
        });


    </script>

</html>